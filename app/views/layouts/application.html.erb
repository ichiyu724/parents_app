<!DOCTYPE html>
<html>
  <head>
    <title><%= full_title(yield(:title)) %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'pagetop' %>
    <link href="https://use.fontawesome.com/releases/v6.1.1/css/all.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400&family=Prompt:wght@300;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/0.0.10/font-awesome-animation.css" type="text/css" media="all" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jscroll/2.4.1/jquery.jscroll.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js" type="text/javascript"></script>
    <script>
      let map;
      let geocoder;
      function initMap() {
        function success(pos) {
          let lat = pos.coords.latitude;
          let lng = pos.coords.longitude;
          let latlng = new google.maps.LatLng(lat, lng);
          geocoder = new google.maps.Geocoder();
          map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: latlng
          });
          marker = new google.maps.Marker({
            position: latlng,
            map: map,
          });
          let request = {
          location: latlng,
          radius: 2000,
          types: ['doctor']
          };
          var service = new google.maps.places.PlacesService(map);
          service.search(request, Result_Places);
        }
        function fail(error) {
          alert('位置情報の取得に失敗しました。エラーコード：' + error.code);
          let latlng = new google.maps.LatLng(35.6812405, 139.7649361);
          let map = new google.maps.Map(document.getElementById('maps'), {
            zoom: 10,
            center: latlng
          });
        }
	      navigator.geolocation.getCurrentPosition(success, fail);
      }
      function Result_Places(results, status){
        if(status == google.maps.places.PlacesServiceStatus.OK) {
          for (let i = 0; i < results.length; i++) {
            let place = results[i];
            createMarker({
              text : place.name,
              position : place.geometry.location
            });
          }
        }
      }
      function createMarker(options) {
        options.map = map;
        let marker = new google.maps.Marker(options);
        let infoWnd = new google.maps.InfoWindow();
        infoWnd.setContent(options.text);
        google.maps.event.addListener(marker, 'click', function(){
          infoWnd.open(map, marker);
        });
        return marker;
      }
      function codeAddress(){
      let inputAddress = document.getElementById('address').value;
      geocoder.geocode( { 'address': inputAddress}, function(results, status) {
        if (status == 'OK') {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
          });
          display.textContent = "検索結果：" + results[ 0 ].geometry.location
        } else {
          alert('該当する結果がありませんでした：' + status);
        }
        });   
      }
    </script>
  </head>

  <body>
    <div class="body">
      <header>
        <%= render "shared/header" %>
      </header>
      <% if flash[:notice] %>
        <div class="alert alert-success alert-dismissible fade show mb-0" role="alert">
          <p class="notice mb-0"><%= flash[:notice] %><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="閉じる"></button></p>
        </div>
      <% end %>
      <% if flash[:alert] %>
        <div class="alert alert-danger alert-dismissible fade show mb-0" role="alert">
          <p class="mb-0"><%= flash.now[:alert] %><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="閉じる"></button></p>
        </div>
      <% end %>
      <%= render "shared/pagetop" %>
      <%= yield %>
      <footer>
        <%= render "shared/footer" %>
      </footer>
    </div>
  </body>
</html>
